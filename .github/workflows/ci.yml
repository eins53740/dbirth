# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application

on:
#  push:
#    branches: [ "main" ]
#  pull_request:
#    branches: [ "main" ]
 workflow_dispatch:

permissions:
  contents: read

jobs:
  uns-metadata-sync:
    name: UNS Metadata Sync Service
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version-file: "pyproject.toml"
    - name: Install uv
      uses: astral-sh/setup-uv@v6
    - name: Install dependencies with uv
      run: |
        python -m pip install --upgrade pip
        # This command syncs the environment EXACTLY to the pyproject.toml
        uv sync --locked --all-extras --dev
    - name: Validate migrations
      env:
        DB_MODE: mock
      run: |
        uv run python - <<'PY'
        from uns_metadata_sync.migrations.runner import load_migrations

        migrations = load_migrations()
        if not migrations:
            raise SystemExit('No migrations found')

        for migration in migrations:
            if not migration.up_sql.strip():
                raise SystemExit(f"Migration {migration.version} missing up SQL")
            if not migration.down_sql.strip():
                raise SystemExit(f"Migration {migration.version} missing down SQL")

        print(f"Validated {len(migrations)} migrations offline")
        PY
    - name: Lint with ruff
      run: |
        # stop the build if there are Python syntax errors or undefined names
        uv run ruff check .
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        uv run black --check .
    - name: Test with pytest
      run: |
        # Run pytest unit and integration tests with coverage
        # Minimum coverage is 70% for unit tests, 30% for integration tests
        uv run pytest -v -m unit --cov=. --cov-report=term-missing --cov-fail-under=70
        #uv run pytest -v -m integration --cov=. --cov-report=term-missing --cov-fail-under=30
        
